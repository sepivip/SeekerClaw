name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-dappstore:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
      GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up JDK 17
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@ac638b010cf58a27ee6c972e999cca798e6adc81 # v4.4.1

      - name: Decode google-services.json
        if: env.GOOGLE_SERVICES_JSON != ''
        run: echo "$GOOGLE_SERVICES_JSON" | base64 -d > app/google-services.json

      - name: Decode dApp Store keystore
        if: env.KEYSTORE_BASE64 != ''
        run: |
          TMPDIR=$(mktemp -d)
          echo "$KEYSTORE_BASE64" | base64 -d > "$TMPDIR/dappstore-release.jks"
          echo "SEEKERCLAW_KEYSTORE_PATH=$TMPDIR/dappstore-release.jks" >> "$GITHUB_ENV"
          echo "KEYSTORE_TMPDIR=$TMPDIR" >> "$GITHUB_ENV"

      - name: Build dApp Store release APK
        run: chmod +x gradlew && ./gradlew assembleDappStoreRelease
        env:
          SEEKERCLAW_STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
          SEEKERCLAW_KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          SEEKERCLAW_KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: Cleanup keystore
        if: always()
        run: rm -rf "${KEYSTORE_TMPDIR:-/dev/null}"

      - name: Verify APK is signed
        if: env.KEYSTORE_BASE64 != ''
        run: |
          APK=$(find app/build/outputs/apk/dappStore/release -name '*.apk' | head -1)
          if [ -z "$APK" ]; then
            echo "::error::No dApp Store release APK found"
            exit 1
          fi
          ${ANDROID_HOME}/build-tools/$(ls ${ANDROID_HOME}/build-tools/ | tail -1)/apksigner verify "$APK"
          echo "APK signed successfully: $APK"

      - name: Rename APK
        run: |
          APK=$(find app/build/outputs/apk/dappStore/release -name '*.apk' | head -1)
          mv "$APK" "SeekerClaw-${{ github.ref_name }}.apk"

      - name: Upload artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: dappstore-apk
          path: "SeekerClaw-${{ github.ref_name }}.apk"

  build-googleplay:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      PLAY_KEYSTORE_BASE64: ${{ secrets.PLAY_KEYSTORE_BASE64 }}
      GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up JDK 17
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@ac638b010cf58a27ee6c972e999cca798e6adc81 # v4.4.1

      - name: Decode google-services.json
        if: env.GOOGLE_SERVICES_JSON != ''
        run: echo "$GOOGLE_SERVICES_JSON" | base64 -d > app/google-services.json

      - name: Decode Google Play keystore
        if: env.PLAY_KEYSTORE_BASE64 != ''
        run: |
          TMPDIR=$(mktemp -d)
          echo "$PLAY_KEYSTORE_BASE64" | base64 -d > "$TMPDIR/googleplay-release.jks"
          echo "PLAY_KEYSTORE_PATH=$TMPDIR/googleplay-release.jks" >> "$GITHUB_ENV"
          echo "PLAY_KEYSTORE_TMPDIR=$TMPDIR" >> "$GITHUB_ENV"

      - name: Build Google Play release AAB
        run: chmod +x gradlew && ./gradlew bundleGooglePlayRelease
        env:
          PLAY_STORE_PASSWORD: ${{ secrets.PLAY_STORE_PASSWORD }}
          PLAY_KEY_ALIAS: ${{ secrets.PLAY_KEY_ALIAS }}
          PLAY_KEY_PASSWORD: ${{ secrets.PLAY_KEY_PASSWORD }}

      - name: Cleanup keystore
        if: always()
        run: rm -rf "${PLAY_KEYSTORE_TMPDIR:-/dev/null}"

      - name: Rename AAB
        run: |
          AAB=$(find app/build/outputs/bundle/googlePlayRelease -name '*.aab' | head -1)
          if [ -n "$AAB" ]; then
            mv "$AAB" "SeekerClaw-${{ github.ref_name }}.aab"
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: googleplay-aab
          path: "SeekerClaw-${{ github.ref_name }}.aab"
          if-no-files-found: ignore

  release:
    needs: [build-dappstore, build-googleplay]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout (for CHANGELOG.md)
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download dApp Store APK
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: dappstore-apk
          path: artifacts/

      - name: Download Google Play AAB
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: googleplay-aab
          path: artifacts/
        continue-on-error: true

      - name: Get version from tag
        id: version
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

      - name: Extract changelog for version
        id: changelog
        run: |
          TAG="${GITHUB_REF#refs/tags/v}"
          # L-16: Validate tag format before awk interpolation
          if ! echo "$TAG" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+'; then
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          NOTES=$(awk "/^## \\[${TAG}\\]/{found=1; next} /^## \\[/{if(found) exit} found{print}" CHANGELOG.md)
          if [ -z "$NOTES" ]; then
            echo "No changelog entry found for v${TAG}, using auto-generated notes"
            echo "found=false" >> "$GITHUB_OUTPUT"
          else
            echo "found=true" >> "$GITHUB_OUTPUT"
            {
              echo "notes<<CHANGELOG_EOF"
              echo "$NOTES"
              echo "CHANGELOG_EOF"
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Create GitHub Release (with changelog)
        if: steps.changelog.outputs.found == 'true'
        uses: softprops/action-gh-release@da05d552573ad5bc57f6a6b8a87f3b4ef3a5a5c4 # v2.2.2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: SeekerClaw ${{ steps.version.outputs.tag }}
          body: ${{ steps.changelog.outputs.notes }}
          files: artifacts/*

      - name: Create GitHub Release (auto-generated notes)
        if: steps.changelog.outputs.found != 'true'
        uses: softprops/action-gh-release@da05d552573ad5bc57f6a6b8a87f3b4ef3a5a5c4 # v2.2.2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: SeekerClaw ${{ steps.version.outputs.tag }}
          generate_release_notes: true
          files: artifacts/*
